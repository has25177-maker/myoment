import streamlit as st
import pandas as pd
from datetime import date

st.set_page_config(page_title="ë¬˜ë©˜íŠ¸", page_icon="ğŸ±", layout="wide")

# -----------------------------
# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
# -----------------------------
if "records" not in st.session_state:
    st.session_state.records = []  # ê±´ê°• ê¸°ë¡ ë¦¬ìŠ¤íŠ¸ (dict)

if "food_db" not in st.session_state:
    # ìŒì‹ ë°ì´í„° (í™•ì¥ë¨)
    st.session_state.food_db = {
        "ë‹­ê°€ìŠ´ì‚´": {"ê°€ëŠ¥": "ì†ŒëŸ‰ ì‚¶ì•„ì„œ ê°€ëŠ¥", "ì£¼ì˜": "ì–‘ë…/ê¸°ë¦„ X"},
        "ì†Œê³ ê¸°": {"ê°€ëŠ¥": "ìµíŒ ì‚´ì½”ê¸°ë§Œ ì†ŒëŸ‰ ê°€ëŠ¥", "ì£¼ì˜": "ì–‘ë… X"},
        "ë¼ì§€ê³ ê¸°": {"ê°€ëŠ¥": "ìµíŒ ì‚´ì½”ê¸° ì ì€ ì–‘", "ì£¼ì˜": "ì§€ë°©/ì–‘ë… ê¸ˆì§€"},
        "ì—°ì–´": {"ê°€ëŠ¥": "ìµíŒ ì—°ì–´ ê°€ëŠ¥", "ì£¼ì˜": "ìƒì—°ì–´/í›ˆì œ ê¸ˆì§€"},
        "ì°¸ì¹˜": {"ê°€ëŠ¥": "ê³ ì–‘ì´ìš© ìº”ë§Œ", "ì£¼ì˜": "ì‚¬ëŒìš© ì°¸ì¹˜ëŠ” ì—¼ë¶„â†‘"},
        "ìš°ìœ ": {"ê°€ëŠ¥": "ë½í† í”„ë¦¬ë§Œ ê°€ëŠ¥", "ì£¼ì˜": "ì¼ë°˜ ìš°ìœ ëŠ” ì„¤ì‚¬ ìœ ë°œ"},
        "ìš”ê±°íŠ¸": {"ê°€ëŠ¥": "ë¬´ê°€ë‹¹ë§Œ ì†ŒëŸ‰", "ì£¼ì˜": "ì„¤íƒ• í¬í•¨ ê¸ˆì§€"},
        "ì¹˜ì¦ˆ": {"ê°€ëŠ¥": "ë¬´ì—¼ ì¹˜ì¦ˆ ì¡°ê¸ˆë§Œ", "ì£¼ì˜": "ì—¼ë¶„Â·ì§€ë°©â†‘"},
        "ë¹µ": {"ê°€ëŠ¥": "ë§›ë³´ê¸° ì†ŒëŸ‰", "ì£¼ì˜": "ë²„í„°/í¬ë¦¼/ì´ˆì½” ê¸ˆì§€"},
        "ê³ êµ¬ë§ˆ": {"ê°€ëŠ¥": "ìµí˜€ì„œ ì†ŒëŸ‰", "ì£¼ì˜": "ë‹¹â†‘ ë¹„ë§Œ ì£¼ì˜"},
        "ê°ì": {"ê°€ëŠ¥": "ìµí˜€ì„œ ê°€ëŠ¥", "ì£¼ì˜": "ìƒê°ì/ì‹¹ ë…ì„±"},
        "ë¸Œë¡œì½œë¦¬": {"ê°€ëŠ¥": "ì‚¶ì•„ì„œ ê°€ëŠ¥", "ì£¼ì˜": "ë„ˆë¬´ ë§ì´ ê¸ˆì§€"},
        "ì‚¬ê³¼": {"ê°€ëŠ¥": "ê³¼ìœ¡ ê°€ëŠ¥", "ì£¼ì˜": "ì”¨/ì‹¬ ì œê±°"},
        "ìˆ˜ë°•": {"ê°€ëŠ¥": "ì”¨ ì œê±°í•˜ê³  ì†ŒëŸ‰", "ì£¼ì˜": "ê³¼ë‹¹â†‘"},
        "ì–‘íŒŒ": {"ê°€ëŠ¥": "ë¶ˆê°€", "ì£¼ì˜": "ì í˜ˆêµ¬ íŒŒê´´ ë¹ˆí˜ˆ"},
        "ë§ˆëŠ˜": {"ê°€ëŠ¥": "ë¶ˆê°€", "ì£¼ì˜": "ì–‘íŒŒì™€ ë™ì¼í•œ ë…ì„±"},
        "ì´ˆì½œë¦¿": {"ê°€ëŠ¥": "ë¶ˆê°€", "ì£¼ì˜": "í…Œì˜¤ë¸Œë¡œë¯¼ ë…ì„±"},
        "í¬ë„": {"ê°€ëŠ¥": "ë¶ˆê°€", "ì£¼ì˜": "ì‹ ì¥ ì†ìƒ ìœ„í—˜"},
        "ê±´í¬ë„": {"ê°€ëŠ¥": "ë¶ˆê°€", "ì£¼ì˜": "í¬ë„ì™€ ë™ì¼ ë…ì„±"},
        "ì»¤í”¼": {"ê°€ëŠ¥": "ë¶ˆê°€", "ì£¼ì˜": "ì¹´í˜ì¸ ë…ì„±"},
        "ì•Œì½”ì˜¬": {"ê°€ëŠ¥": "ë¶ˆê°€", "ì£¼ì˜": "ì†ŒëŸ‰ë„ ì¹˜ëª…ì "},
    }


# -----------------------------
# ìœ í‹¸ í•¨ìˆ˜
# -----------------------------
def add_record(rec: dict):
    st.session_state.records.append(rec)


def get_records_df():
    if not st.session_state.records:
        return pd.DataFrame()
    return pd.DataFrame(st.session_state.records)


# -----------------------------
# í˜ì´ì§€ 1. ê±´ê°• ê¸°ë¡
# -----------------------------
def page_health_log():
    st.title("ğŸ“’ ê±´ê°• ê¸°ë¡")

    col1, col2 = st.columns(2)

    with col1:
        rec_date = st.date_input("ê¸°ë¡ ë‚ ì§œ", value=date.today())

        meal = st.radio(
            "ğŸ½ ì‹ì‚¬ëŸ‰",
            ["ê±°ì˜ ì•ˆ ë¨¹ìŒ", "í‰ì†Œë³´ë‹¤ ì ê²Œ", "í‰ì†Œì™€ ë¹„ìŠ·", "í‰ì†Œë³´ë‹¤ ë§ì´"],
            index=2,
        )

        water = st.radio(
            "ğŸ’§ ìŒìˆ˜ëŸ‰",
            ["ê±°ì˜ ì•ˆ ë§ˆì‹¬", "í‰ì†Œë³´ë‹¤ ì ê²Œ", "í‰ì†Œì™€ ë¹„ìŠ·", "í‰ì†Œë³´ë‹¤ ë§ì´"],
            index=2,
        )

        poop = st.radio(
            "ğŸ’© ë°°ë³€ ìƒíƒœ",
            ["ì •ìƒ", "ë‹¨ë‹¨í•¨", "ë¬´ë¦„/ì„¤ì‚¬", "í˜ˆë³€/ê²€ì€ ë³€", "ì•ˆ ë´„"],
            index=0,
        )

        # â­ êµ¬í†  ê¸°ë¡
        vomit_yes = st.radio("ğŸ¤® êµ¬í†  ì—¬ë¶€", ["ì—†ìŒ", "ìˆìŒ"], index=0)

        vomit_color = ""
        vomit_type = ""
        vomit_amount = ""
        vomit_count = ""

        if vomit_yes == "ìˆìŒ":
            vomit_color = st.selectbox(
                "êµ¬í†  ìƒ‰ê¹”",
                ["ë…¸ë€ìƒ‰(ë‹´ì¦™)", "íˆ¬ëª…/ê±°í’ˆ", "ê°ˆìƒ‰", "ìŒì‹ë¬¼", "ë¶„í™/ë¶‰ì€ ê¸°ìš´", "ê¸°íƒ€"],
            )

            vomit_type = st.selectbox(
                "êµ¬í†  ì¢…ë¥˜",
                ["í—¤ì–´ë³¼", "ìŒì‹í† ", "ë¬¼í† ", "ê±°í’ˆí† ", "ì´ë¬¼ ê°€ëŠ¥ì„±", "ê¸°íƒ€"],
            )

            vomit_amount = st.radio("êµ¬í†  ì–‘", ["ì ìŒ", "ë³´í†µ", "ë§ìŒ"], index=1)

            vomit_count = st.radio(
                "êµ¬í†  íšŸìˆ˜ (ì˜¤ëŠ˜)", ["1íšŒ", "2~3íšŒ", "4íšŒ ì´ìƒ"], index=0
            )

    with col2:
        activity = st.multiselect(
            "ğŸƒ í™œë™ ë° í–‰ë™ (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)",
            [
                "í‰ì†Œì™€ ë¹„ìŠ·",
                "ì ì´ ë§ì•„ì§",
                "í™œë™ì´ ì¤„ì–´ë“¦",
                "í™œë™ì´ ëŠ˜ì–´ë‚¨",
                "ì˜ˆë¯¼/ê³µê²©ì ",
                "ìˆ¨ëŠ” ì‹œê°„ì´ ë§ìŒ",
                "ì•¼ì˜¹ê±°ë¦¼ ì¦ê°€",
            ],
            default=["í‰ì†Œì™€ ë¹„ìŠ·"],
        )

        symptoms = st.multiselect(
            "âš ï¸ ì´ìƒ ì¦ì„¸",
            ["ê¸°ì¹¨", "í˜¸í¡ ì´ìƒ", "ë‹¤ë¦¬ë¥¼ ì ˆìŒ", "ëˆˆ/ì½” ë¶„ë¹„ë¬¼", "ê°€ë ¤ì›€", "ê¸°íƒ€"],
        )

        memo = st.text_area(
            "ğŸ“ íŠ¹ì´ì‚¬í•­ ë©”ëª¨ (ì„ íƒ)",
            placeholder="í‰ì†Œì™€ ë‹¬ëë˜ ì , ë¨¹ì€ ê°„ì‹, í™˜ê²½ ë³€í™” ë“±"
        )

    if st.button("ê¸°ë¡ ì €ì¥"):
        rec = {
            "ë‚ ì§œ": rec_date,
            "ì‹ì‚¬ëŸ‰": meal,
            "ìŒìˆ˜ëŸ‰": water,
            "ë°°ë³€": poop,
            "í–‰ë™": ", ".join(activity) if activity else "",
            "ì´ìƒì¦ì„¸": ", ".join(symptoms) if symptoms else "",
            "êµ¬í†  ì—¬ë¶€": vomit_yes,
            "êµ¬í†  ìƒ‰": vomit_color,
            "êµ¬í†  ì¢…ë¥˜": vomit_type,
            "êµ¬í†  ì–‘": vomit_amount,
            "êµ¬í†  íšŸìˆ˜": vomit_count,
            "ë©”ëª¨": memo,
        }
        add_record(rec)
        st.success("ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")

    st.markdown("---")
    st.subheader("ğŸ“š ìµœê·¼ ê¸°ë¡")

    df = get_records_df()
    if df.empty:
        st.info("ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.")
    else:
        st.dataframe(df.tail(10), use_container_width=True)


# -----------------------------
# í˜ì´ì§€ 2. AI ì§„ë‹¨ (êµ¬í†  ë¶„ì„ ì¶”ê°€)
# -----------------------------
def page_ai_diagnosis():
    st.title("ğŸ“Š AI ì§„ë‹¨")

    df = get_records_df()
    if df.empty:
        st.info("ìµœì†Œ 1ê°œ ì´ìƒ ê¸°ë¡ í•„ìš”")
        return

    recent = df.tail(7)

    warnings = []
    tips = []

    # â— ì‹ì‚¬ëŸ‰
    if (recent["ì‹ì‚¬ëŸ‰"].isin(["ê±°ì˜ ì•ˆ ë¨¹ìŒ", "í‰ì†Œë³´ë‹¤ ì ê²Œ"])).sum() >= 2:
        warnings.append("ì‹ì‚¬ëŸ‰ ê°ì†Œê°€ ë°˜ë³µë˜ê³  ìˆì–´ìš”.")
        tips.append("24ì‹œê°„ ì´ìƒ ê±°ì˜ ë¨¹ì§€ ì•Šìœ¼ë©´ ë³‘ì› ìƒë‹´ì´ í•„ìš”í•´ìš”.")

    # â— ë¬¼
    if (recent["ìŒìˆ˜ëŸ‰"].isin(["ê±°ì˜ ì•ˆ ë§ˆì‹¬", "í‰ì†Œë³´ë‹¤ ì ê²Œ"])).sum() >= 2:
        warnings.append("ë¬¼ ì„­ì·¨ëŸ‰ì´ ì¤„ì–´ë“  ë‚ ì´ ì—¬ëŸ¬ ë²ˆ ìˆì–´ìš”.")
        tips.append("ë°©ê´‘ì—¼/ìš”ë¡œê³„ ë¬¸ì œì˜ ì‹ í˜¸ì¼ ìˆ˜ ìˆì–´ìš”.")

    # â— ë°°ë³€
    if (recent["ë°°ë³€"].isin(["ë¬´ë¦„/ì„¤ì‚¬", "í˜ˆë³€/ê²€ì€ ë³€", "ì•ˆ ë´„"])).sum() >= 2:
        warnings.append("ë°°ë³€ ì´ìƒì´ ë°˜ë³µë˜ê³  ìˆì–´ìš”.")
        tips.append("3ì¼ ì´ìƒ ì§€ì†ë˜ë©´ ì§„ë£Œ í•„ìš”.")

    # â— í–‰ë™
    if recent["í–‰ë™"].str.contains("í™œë™ì´ ì¤„ì–´ë“¦|ì ì´ ë§ì•„ì§|ìˆ¨ëŠ” ì‹œê°„", na=False).sum() >= 2:
        warnings.append("ë¬´ê¸°ë ¥/ìˆ¨ê¸° ë“± ìŠ¤íŠ¸ë ˆìŠ¤ ë˜ëŠ” í†µì¦ ì‹ í˜¸ê°€ ë³´ì—¬ìš”.")

    # â­ êµ¬í†  íŒ¨í„´ ë¶„ì„
    vomit_records = recent[recent["êµ¬í†  ì—¬ë¶€"] == "ìˆìŒ"]

    if len(vomit_records) >= 2:
        warnings.append("ìµœê·¼ ë©°ì¹  ê°„ êµ¬í† ê°€ ë°˜ë³µì ìœ¼ë¡œ ê´€ì°°ë˜ê³  ìˆì–´ìš”.")

        # êµ¬í†  ì¢…ë¥˜ë³„ í•´ì„
        if "í—¤ì–´ë³¼" in " ".join(vomit_records["êµ¬í†  ì¢…ë¥˜"]):
            tips.append("í—¤ì–´ë³¼ êµ¬í† ê°€ ì¦ìœ¼ë©´ ë¹—ì§ˆÂ·í—¤ì–´ë³¼ ì‚¬ë£Œ ë„ì›€ì´ ë¼ìš”.")

        if "ê±°í’ˆí† " in " ".join(vomit_records["êµ¬í†  ì¢…ë¥˜"]):
            tips.append("í—ˆê¸°ì„± êµ¬í† ì¼ ìˆ˜ ìˆì–´ìš”. ì†ŒëŸ‰ì”© ìì£¼ ê¸‰ì—¬ê°€ ì¢‹ì•„ìš”.")

        if "ì´ë¬¼" in " ".join(vomit_records["êµ¬í†  ì¢…ë¥˜"]):
            warnings.append("âš  ì´ë¬¼ ì„­ì·¨ ê°€ëŠ¥ì„±ì´ ìˆì–´ìš”. ì¦‰ì‹œ ë³‘ì› ê¶Œì¥.")

        if "ë¶„í™" in " ".join(vomit_records["êµ¬í†  ìƒ‰"]):
            warnings.append("âš  í˜ˆì„± êµ¬í†  ì˜ì‹¬. ì¦‰ì‹œ ë³‘ì› ë°©ë¬¸ í•„ìš”.")

        if (vomit_records["êµ¬í†  íšŸìˆ˜"] == "4íšŒ ì´ìƒ").sum() >= 1:
            warnings.append("ì˜¤ëŠ˜ êµ¬í†  íšŸìˆ˜ê°€ ë§ì•„ìš”. íƒˆìˆ˜ ìœ„í—˜ ìˆìœ¼ë‹ˆ ë³‘ì› ìƒë‹´ ê¶Œì¥.")

    # ê²°ê³¼ ì¶œë ¥
    if not warnings:
        st.success("íŠ¹ë³„í•œ ìœ„í—˜ ì‹ í˜¸ëŠ” ê°ì§€ë˜ì§€ ì•Šì•˜ì–´ìš”.")
    else:
        st.subheader("âš  ì£¼ì˜ê°€ í•„ìš”í•œ ë³€í™”")
        for w in warnings:
            st.warning("- " + w)

    if tips:
        st.subheader("ğŸ’¡ ì°¸ê³  íŒ")
        for t in tips:
            st.write("- " + t)

    with st.expander("ìµœê·¼ ê¸°ë¡ 7ê°œ ë³´ê¸°"):
        st.dataframe(recent, use_container_width=True)
