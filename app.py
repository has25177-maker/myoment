import streamlit as st
import pandas as pd
from datetime import date

# ======================================
# ê¸°ë³¸ ì„¤ì • + ë””ìì¸ í…Œë§ˆ
# ======================================
st.set_page_config(page_title="ë¬˜ë©˜íŠ¸", page_icon="ğŸ±", layout="wide")

# ì „ì²´ ë°°ê²½/í°íŠ¸ í†¤ ì¡°ì • (PPT ë¶„ìœ„ê¸° ë§ì¶¤)
CUSTOM_CSS = """
<style>
body {
    background-color: #FAF4EF !important;
}

section.main > div {
    background-color: #FAF4EF !important;
}

h1, h2, h3, h4, h5, h6, label, p, span {
    font-family: "Apple SD Gothic Neo", "Helvetica Neue", sans-serif !important;
    color: #5A4632 !important;
}

.sidebar .sidebar-content {
    background-color: #F4ECE6 !important;
}

.stButton>button {
    border-radius: 10px;
    background-color: #F6D7C3;
    color: #5A4632;
    border: 0px;
}
.stButton>button:hover {
    background-color: #F1C7B0;
    color: #4A3A2A;
}

.stRadio > label, .stSelectbox > label {
    font-weight: 600 !important;
    color: #5A4632 !important;
}
</style>
"""
st.markdown(CUSTOM_CSS, unsafe_allow_html=True)

# ======================================
# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
# ======================================
if "records" not in st.session_state:
    st.session_state.records = []  # ê±´ê°• ê¸°ë¡ ì €ì¥

if "food_db" not in st.session_state:
    # ìŒì‹ DB (í™•ì¥)
    st.session_state.food_db = {
        "ë‹­ê°€ìŠ´ì‚´": {"ê°€ëŠ¥": "ì†ŒëŸ‰ ì‚¶ì•„ì„œ ê°€ëŠ¥", "ì£¼ì˜": "ì–‘ë… ê¸ˆì§€"},
        "ì†Œê³ ê¸°": {"ê°€ëŠ¥": "ê¸°ë¦„ ì ì€ ë¶€ìœ„ ìµí˜€ì„œ ê°€ëŠ¥", "ì£¼ì˜": "ì–‘ë… ê¸ˆì§€"},
        "ë¼ì§€ê³ ê¸°": {"ê°€ëŠ¥": "ìµí˜€ì„œ ì†ŒëŸ‰ ê°€ëŠ¥", "ì£¼ì˜": "ê¸°ë¦„Â·ì–‘ë… ì£¼ì˜"},
        "ì—°ì–´": {"ê°€ëŠ¥": "ìµíŒ ì—°ì–´ë§Œ ì†ŒëŸ‰ ê°€ëŠ¥", "ì£¼ì˜": "ìƒì—°ì–´Â·í›ˆì œ ê¸ˆì§€"},
        "ìš°ìœ ": {"ê°€ëŠ¥": "ê³ ì–‘ì´ ì „ìš© ë½í† í”„ë¦¬ë§Œ ê°€ëŠ¥", "ì£¼ì˜": "ì¼ë°˜ ìš°ìœ  ê¸ˆì§€"},
        "ìš”ê±°íŠ¸": {"ê°€ëŠ¥": "ë¬´ê°€ë‹¹ë§Œ ê·¹ì†ŒëŸ‰ ê°€ëŠ¥", "ì£¼ì˜": "ì„¤íƒ•Â·ê°ë¯¸ë£Œ ê¸ˆì§€"},
        "ì‚¬ê³¼": {"ê°€ëŠ¥": "ì”¨ ì œê±° í›„ ê³¼ìœ¡ë§Œ ì†ŒëŸ‰ ê°€ëŠ¥", "ì£¼ì˜": "ì”¨Â·ì‹¬ ë…ì„± ì£¼ì˜"},
        "ìˆ˜ë°•": {"ê°€ëŠ¥": "ê³¼ìœ¡ë§Œ ì†ŒëŸ‰ ê°€ëŠ¥", "ì£¼ì˜": "ê³¼ë‹¹ ì£¼ì˜"},
        "ê³ êµ¬ë§ˆ": {"ê°€ëŠ¥": "ìµíŒ ê³ êµ¬ë§ˆ ì†ŒëŸ‰ ê°€ëŠ¥", "ì£¼ì˜": "ë‹¹ë¶„ ì£¼ì˜"},
        "ë¸Œë¡œì½œë¦¬": {"ê°€ëŠ¥": "ì‚¶ì•„ì„œ ì†ŒëŸ‰ ê°€ëŠ¥", "ì£¼ì˜": "ê°€ìŠ¤ ì£¼ì˜"},
        "ì´ˆì½œë¦¿": {"ê°€ëŠ¥": "ë¶ˆê°€", "ì£¼ì˜": "í…Œì˜¤ë¸Œë¡œë¯¼ ë…ì„±"},
        "ì–‘íŒŒ": {"ê°€ëŠ¥": "ë¶ˆê°€", "ì£¼ì˜": "ì í˜ˆêµ¬ íŒŒê´´"},
        "ë§ˆëŠ˜": {"ê°€ëŠ¥": "ë¶ˆê°€", "ì£¼ì˜": "ë…ì„± ì„±ë¶„"},
        "í¬ë„": {"ê°€ëŠ¥": "ë¶ˆê°€", "ì£¼ì˜": "ì‹ ì¥ ì†ìƒ ìœ„í—˜"},
        "ì»¤í”¼": {"ê°€ëŠ¥": "ë¶ˆê°€", "ì£¼ì˜": "ì¹´í˜ì¸ ë…ì„±"},
    }

# ======================================
# ìœ í‹¸ í•¨ìˆ˜
# ======================================
def add_record(record):
    st.session_state.records.append(record)

def get_records_df():
    if len(st.session_state.records) == 0:
        return pd.DataFrame()
    return pd.DataFrame(st.session_state.records)

# ======================================
# 1. ê±´ê°• ê¸°ë¡
# ======================================
def page_health_log():
    st.title("ğŸ“’ ê±´ê°• ê¸°ë¡")

    col1, col2 = st.columns(2)

    with col1:
        date_v = st.date_input("ê¸°ë¡ ë‚ ì§œ", value=date.today())
        meal = st.radio("ğŸ½ ì‹ì‚¬ëŸ‰", ["ê±°ì˜ ì•ˆ ë¨¹ìŒ", "ì ê²Œ ë¨¹ìŒ", "ë³´í†µ", "ë§ì´ ë¨¹ìŒ"], index=2)
        water = st.radio("ğŸ’§ ìŒìˆ˜ëŸ‰", ["ê±°ì˜ ì•ˆ ë§ˆì‹¬", "ì ê²Œ", "ë³´í†µ", "ë§ì´"], index=2)
        poop = st.radio("ğŸ’© ë°°ë³€", ["ì •ìƒ", "ë‹¨ë‹¨í•¨", "ì„¤ì‚¬", "í˜ˆë³€", "ì•ˆ ë´„"])

    with col2:
        activity = st.multiselect(
            "ğŸƒ í™œë™/í–‰ë™",
            ["ë³´í†µ", "ì ì´ ë§ìŒ", "í™œë™ ê°ì†Œ", "í™œë™ ì¦ê°€", "ì˜ˆë¯¼í•¨", "ìˆ¨ìŒ", "ì•¼ì˜¹ê±°ë¦¼ ì¦ê°€"],
            default=["ë³´í†µ"],
        )
        symptoms = st.multiselect(
            "âš ï¸ ì´ìƒì¦ì„¸",
            ["êµ¬í† ", "ê¸°ì¹¨", "í˜¸í¡ ì´ìƒ", "ì ˆëšê±°ë¦¼", "ëˆˆ/ì½” ë¶„ë¹„ë¬¼", "ê°€ë ¤ì›€", "ê¸°íƒ€"]
        )

        # ì¶”ê°€: êµ¬í†  ìƒì„¸ ì…ë ¥
        vomit_detail = ""
        vomit_color = ""
        if "êµ¬í† " in symptoms:
            st.write("### ğŸ¤® êµ¬í†  ìƒì„¸ ì •ë³´")
            vomit_color = st.selectbox("êµ¬í†  ìƒ‰", ["íˆ¬ëª…/ê±°í’ˆ", "ë…¸ë€ìƒ‰(ë‹´ì¦™)", "ê°ˆìƒ‰/ì‚¬ë£Œ", "ë¶‰ì€ìƒ‰(í˜ˆì•¡ ê°€ëŠ¥)", "ê¸°íƒ€"])
            vomit_detail = st.selectbox("êµ¬í†  ë‚´ìš©ë¬¼", ["í—¤ì–´ë³¼", "ì‚¬ë£Œ", "ê±°í’ˆ", "ì•¡ì²´", "ì´ë¬¼ì§ˆ ì¶”ì •", "ê¸°íƒ€"])

        memo = st.text_area("ğŸ“ ë©”ëª¨", placeholder="íŠ¹ì´ì‚¬í•­")

    if st.button("ê¸°ë¡ ì €ì¥"):
        add_record({
            "ë‚ ì§œ": date_v,
            "ì‹ì‚¬ëŸ‰": meal,
            "ìŒìˆ˜ëŸ‰": water,
            "ë°°ë³€": poop,
            "í–‰ë™": ", ".join(activity),
            "ì´ìƒì¦ì„¸": ", ".join(symptoms),
            "êµ¬í† ìƒ‰": vomit_color,
            "êµ¬í† ë‚´ìš©": vomit_detail,
            "ë©”ëª¨": memo,
        })
        st.success("ì €ì¥ ì™„ë£Œ!")

    st.markdown("---")
    st.subheader("ğŸ“š ìµœì‹  ê¸°ë¡")
    df = get_records_df()
    if df.empty:
        st.info("ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.")
    else:
        st.dataframe(df.tail(10), use_container_width=True)

# ======================================
# 2. AI ì§„ë‹¨
# ======================================
def page_ai_diagnosis():
    st.title("ğŸ“Š AI ì§„ë‹¨")

    df = get_records_df()
    if df.empty:
        st.info("ê±´ê°• ê¸°ë¡ì„ ë¨¼ì € ì‘ì„±í•´ ì£¼ì„¸ìš”.")
        return

    recent = df.tail(7)
    warns = []
    tips = []

    # ì‹ì‚¬ëŸ‰
    if (recent["ì‹ì‚¬ëŸ‰"].isin(["ê±°ì˜ ì•ˆ ë¨¹ìŒ", "ì ê²Œ ë¨¹ìŒ"])).sum() >= 2:
        warns.append("ìµœê·¼ ì‹ì‚¬ëŸ‰ì´ ì ì€ ë‚ ì´ ë°˜ë³µë˜ê³  ìˆì–´ìš”.")
        tips.append("ì‹ìš•ì €í•˜ëŠ” ë‹¤ì–‘í•œ ì§ˆë³‘ì˜ ì´ˆê¸° ì‹ í˜¸ì¼ ìˆ˜ ìˆì–´ìš”.")

    # ìŒìˆ˜ëŸ‰
    if (recent["ìŒìˆ˜ëŸ‰"].isin(["ê±°ì˜ ì•ˆ ë§ˆì‹¬", "ì ê²Œ"])).sum() >= 2:
        warns.append("ë¬¼ ì„­ì·¨ëŸ‰ì´ ì ì€ ë‚ ì´ ë§ì•„ìš”.")
        tips.append("ìš”ë¡œê³„ ë¬¸ì œ ê°€ëŠ¥ì„±ì„ ì£¼ì˜ ê¹Šê²Œ ë´ ì£¼ì„¸ìš”.")

    # ë°°ë³€
    if (recent["ë°°ë³€"].isin(["ì„¤ì‚¬", "í˜ˆë³€", "ì•ˆ ë´„"])).sum() >= 2:
        warns.append("ë°°ë³€ ì´ìƒì´ ì—¬ëŸ¬ ë²ˆ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.")
        tips.append("3ì¼ ì´ìƒ ì§€ì†ë˜ë©´ ë³‘ì› ì§„ë£Œ ê¶Œì¥.")

    # í–‰ë™
    if recent["í–‰ë™"].str.contains("í™œë™ ê°ì†Œ|ìˆ¨ìŒ|ì ì´ ë§ìŒ", na=False).sum() >= 2:
        warns.append("ë¬´ê¸°ë ¥/ìˆ¨ìŒì´ ë°˜ë³µë˜ê³  ìˆì–´ìš”.")
        tips.append("ìŠ¤íŠ¸ë ˆìŠ¤ ë˜ëŠ” ì§ˆë³‘ ì‹ í˜¸ì¼ ìˆ˜ ìˆì–´ìš”.")

    # êµ¬í† 
    if recent["ì´ìƒì¦ì„¸"].str.contains("êµ¬í† ", na=False).sum() >= 2:
        warns.append("êµ¬í†  íšŸìˆ˜ê°€ ë§ìŠµë‹ˆë‹¤.")
        tips.append("í—¤ì–´ë³¼, ì¥ ë¬¸ì œ ë“± ì›ì¸ í™•ì¸ í•„ìš”.")

    if not warns:
        st.success("ìµœê·¼ ê¸°ë¡ì€ ì „ë°˜ì ìœ¼ë¡œ ì•ˆì •ì ì…ë‹ˆë‹¤.")
    else:
        st.subheader("âš ï¸ ì£¼ì˜ í•„ìš”")
        for w in warns:
            st.warning(w)
    if tips:
        st.subheader("ğŸ’¡ ì°¸ê³ ")
        for t in tips:
            st.write("- " + t)

# ======================================
# 3. ì§‘ì‚¬ ê°€ì´ë“œ
# ======================================
def page_guide():
    st.title("ğŸ“š ì§‘ì‚¬ ê°€ì´ë“œ")

    tabs = st.tabs([
        "ê¸°ë³¸ ê°€ì´ë“œ", "ì•½ ë¨¹ì´ê¸°", "ê²©ë¦¬Â·ì ì‘",
        "ëª©ìš•", "ë°œí†± ê´€ë¦¬", "ë…¸ë ¹ë¬˜ ê´€ë¦¬",
        "ì¤‘ì„±í™” ì´í›„", "ë‹¤ì´ì–´íŠ¸", "ëŒ€í‘œ ì§ˆë³‘ ì§•í›„"
    ])

    guide_contents = [
        ["ì•ˆì „í•œ ê³µê°„ ì œê³µ", "ë°¥Â·ë¬¼Â·í™”ì¥ì‹¤ ìœ„ì¹˜ ê³ ì •", "í™˜ê²½ ë³€í™” ìµœì†Œí™”"],
        ["í•„ í¬ì¼“ í™œìš©", "ê°€ë£¨ëŠ” ì†ŒëŸ‰ ì„ê¸°", "ê¸ì • ê²½í—˜ ì—°ê²°"],
        ["ì²˜ìŒì—” ê²©ë¦¬", "ëƒ„ìƒˆ êµí™˜", "ì§§ì€ ì‹œê°„ì”© ëŒ€ë©´"],
        ["í•„ìš”ì‹œ ì§§ê²Œ", "ì „ìš© ìƒ´í‘¸", "ì™„ì „ ê±´ì¡°"],
        ["í•œ ë°œê°€ë½ì”©", "í•‘í¬ í˜ˆê´€ í”¼í•˜ê¸°", "í„°ì¹˜ ì ì‘"],
        ["ê´€ì ˆÂ·ì‹ ì¥ ë¬¸ì œ ì¦ê°€", "ì í”„ ì¤„ì´ê¸°", "ì •ê¸° ê²€ì§„"],
        ["ë„¥ì¹´ë¼ ì°©ìš©", "ë¶“ê¸°/ì¶œí˜ˆ í™•ì¸", "ì‚¬ë£Œ ì–‘ ì¡°ì ˆ"],
        ["ê¸‰ì—¬ëŸ‰ ë‚˜ëˆ ì£¼ê¸°", "ì €ì¹¼ë¡œë¦¬ ì‚¬ë£Œ", "ê¸‰ê²© ê°ëŸ‰ ê¸ˆì§€"],
        ["ë°©ê´‘ì—¼", "ì¥ ë¬¸ì œ", "êµ¬ê°• ë¬¸ì œ", "í˜¸í¡ê¸° ë¬¸ì œ"],
    ]

    for idx, tab in enumerate(tabs):
        with tab:
            for line in guide_contents[idx]:
                st.write("- " + line)

# ======================================
# 4. ì‘ê¸‰ìƒí™© AI
# ======================================
def page_ai_emergency():
    st.title("ğŸš¨ ì‘ê¸‰ìƒí™© AI")

    mode = st.selectbox("ìƒí™© ì„ íƒ", ["ì„ íƒ", "ê±´ê°• ì‘ê¸‰", "ì‹¬íì†Œìƒìˆ ", "ì¬ë‚œ ìƒí™©", "ê³ ì–‘ì´ ì‹¤ì¢…"])

    if mode == "ê±´ê°• ì‘ê¸‰":
        st.subheader("ì£¼ìš” ì¦ìƒ ì„ íƒ")
        symptom = st.selectbox("ì¦ìƒ", ["ë°˜ë³µ êµ¬í† ", "ì„¤ì‚¬", "í˜¸í¡ ê³¤ë€", "ë¬´ê¸°ë ¥", "ì¶œí˜ˆ"])
        if st.button("ì‘ê¸‰ ì•ˆë‚´ ë³´ê¸°"):
            if symptom == "ë°˜ë³µ êµ¬í† ":
                st.write("- ì‚¬ë£Œ/ë¬¼ ì¼ì‹œ ì¤‘ë‹¨")
                st.write("- êµ¬í†  íšŸìˆ˜ ê¸°ë¡")
                st.write("- 24ì‹œê°„ ì´ìƒ ì§€ì† ì‹œ ë³‘ì›")
            elif symptom == "í˜¸í¡ ê³¤ë€":
                st.error("ë§¤ìš° ê¸´ê¸‰! ì¦‰ì‹œ ë³‘ì› ì´ë™")

    elif mode == "ì‹¬íì†Œìƒìˆ ":
        st.subheader("ì‹¬íì†Œìƒìˆ  ê¸°ë³¸ ê°œë…")
        st.write("- ì˜ì‹ í™•ì¸ â†’ í˜¸í¡ í™•ì¸")
        st.write("- ì‘ì€ ê³ ì–‘ì´ëŠ” ë‘ ì†ê°€ë½ìœ¼ë¡œ ì••ë°•")

    elif mode == "ì¬ë‚œ ìƒí™©":
        st.write("- ì´ë™ì¥ ì¤€ë¹„")
        st.write("- ì°½ë¬¸/ë–¨ì–´ì§ˆ ë¬¼ê±´ ê°€ê¹Œì´ í”¼í•˜ê¸°")

    elif mode == "ê³ ì–‘ì´ ì‹¤ì¢…":
        st.write("- ì§‘ ì£¼ë³€ 50m ì •ìˆ™ íƒìƒ‰")
        st.write("- ëƒ„ìƒˆ ìˆëŠ” ë¬¼ê±´ ë°°ì¹˜")

# ======================================
# 5. ìŒì‹ ì‚¬ì „
# ======================================
def page_food_dict():
    st.title("ğŸ™ ìŒì‹ ì‚¬ì „")

    db = st.session_state.food_db
    name = st.text_input("ìŒì‹ ê²€ìƒ‰")
    if st.button("ê²€ìƒ‰"):
        n = name.strip()
        if n in db:
            info = db[n]
            if info["ê°€ëŠ¥"] == "ë¶ˆê°€":
                st.error(f"âŒ {n} : ì ˆëŒ€ ê¸‰ì—¬ ê¸ˆì§€")
            else:
                st.success(f"â­• {n} : {info['ê°€ëŠ¥']}")
            st.write("- ì£¼ì˜:", info["ì£¼ì˜"])
        else:
            st.warning("ë°ì´í„° ì—†ìŒ")

    with st.expander("ë“±ë¡ëœ ìŒì‹ ëª©ë¡"):
        st.dataframe(pd.DataFrame([
            {"ìŒì‹": key, "ê°€ëŠ¥": v["ê°€ëŠ¥"], "ì£¼ì˜": v["ì£¼ì˜"]}
            for key, v in db.items()
        ]))

# ======================================
# 6. ë§ˆì¼“
# ======================================
def page_market():
    st.title("ğŸ›ï¸ ë§ˆì¼“ ì¶”ì²œ")
    df = get_records_df()
    if df.empty:
        st.info("ê¸°ë¡ ê¸°ë°˜ ë§ì¶¤ ì¶”ì²œì„ ìœ„í•´ ê±´ê°• ê¸°ë¡ì´ í•„ìš”í•©ë‹ˆë‹¤.")
        return

    last = df.iloc[-1]
    st.write("ìµœê·¼ ìƒíƒœ ê¸°ë°˜ ì¶”ì²œ:")

    state = ""
    if last["ë°°ë³€"] in ["ì„¤ì‚¬", "í˜ˆë³€"]:
        state = "ì¥ ê±´ê°•"
    elif last["ìŒìˆ˜ëŸ‰"] in ["ê±°ì˜ ì•ˆ ë§ˆì‹¬", "ì ê²Œ"]:
        state = "ìˆ˜ë¶„ ë¶€ì¡±"
    elif last["ì‹ì‚¬ëŸ‰"] in ["ê±°ì˜ ì•ˆ ë¨¹ìŒ", "ì ê²Œ ë¨¹ìŒ"]:
        state = "ì‹ìš• ì €í•˜"
    else:
        state = "ì •ìƒ"

    st.subheader(f"ìƒíƒœ: {state}")

    if state == "ì¥ ê±´ê°•":
        st.write("- ì €ìê·¹ ì‚¬ë£Œ")
        st.write("- ìœ ì‚°ê·  ê°„ì‹")
    elif state == "ìˆ˜ë¶„ ë¶€ì¡±":
        st.write("- ìŠµì‹ ì‚¬ë£Œ")
        st.write("- êµ­ë¬¼ ê°„ì‹")
    elif state == "ì‹ìš• ì €í•˜":
        st.write("- í–¥ ê°•í•œ ìŠµì‹")
        st.write("- ì†ŒëŸ‰ì”© ë‚˜ëˆ ì£¼ê¸°")
    else:
        st.write("- ê· í˜•í˜• ì‚¬ë£Œ ì¶”ì²œ")

# ======================================
# ë©”ë‰´ ë¼ìš°íŒ…
# ======================================
menu = st.sidebar.radio(
    "ë©”ë‰´",
    ["í™ˆ", "ê±´ê°• ê¸°ë¡", "AI ì§„ë‹¨", "ì§‘ì‚¬ ê°€ì´ë“œ", "ì‘ê¸‰ìƒí™© AI", "ìŒì‹ ì‚¬ì „", "ë§ˆì¼“"]
)

if menu == "í™ˆ":
    st.title("ğŸ± ë¬˜ë©˜íŠ¸")
    st.write("")
    st.write("")
    st.image("https://raw.githubusercontent.com/maywell22/image-hosting/main/cat_illustration_banner.png")

elif menu == "ê±´ê°• ê¸°ë¡":
    page_health_log()

elif menu == "AI ì§„ë‹¨":
    page_ai_diagnosis()

elif menu == "ì§‘ì‚¬ ê°€ì´ë“œ":
    page_guide()

elif menu == "ì‘ê¸‰ìƒí™© AI":
    page_ai_emergency()

elif menu == "ìŒì‹ ì‚¬ì „":
    page_food_dict()

elif menu == "ë§ˆì¼“":
    page_market()
