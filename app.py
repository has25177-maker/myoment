import os
import streamlit as st

# -------------------------------
# 1) í°íŠ¸ íŒŒì¼ ì ˆëŒ€ê²½ë¡œ ì•ˆì „ ìƒì„±
# -------------------------------
FONT_PATH = os.path.join(os.path.dirname(__file__), "BakDahyun.woff2")

# -------------------------------
# 2) ì»¤ìŠ¤í…€ í°íŠ¸ ë¡œë”©
# -------------------------------
def load_custom_font():
    if not os.path.exists(FONT_PATH):
        st.write("âš  í°íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", FONT_PATH)
        return

    # woff2ëŠ” base64 ì¸ì½”ë”©í•´ì•¼ CSSì—ì„œ ì‚¬ìš© ê°€ëŠ¥
    import base64
    with open(FONT_PATH, "rb") as f:
        font_bytes = f.read()
        encoded = base64.b64encode(font_bytes).decode()

    font_css = f"""
    <style>
    @font-face {{
        font-family: 'MyoFont';
        src: url(data:font/woff2;base64,{encoded}) format('woff2');
        font-weight: normal;
        font-style: normal;
    }}

    html, body, [class*="css"] {{
        font-family: 'MyoFont', sans-serif !important;
    }}
    </style>
    """

    st.markdown(font_css, unsafe_allow_html=True)

# -------------------------------
# 3) ì‹¤í–‰
# -------------------------------
load_custom_font()


import streamlit as st
import pandas as pd
from datetime import date
import base64
import requests

# ======================================
# 0. ì„¤ì • & ì¹´ì¹´ì˜¤ API í‚¤
# ======================================
st.set_page_config(page_title="ë¬˜ë©˜íŠ¸", page_icon="â™§", layout="wide")

# ğŸ”‘ ì¹´ì¹´ì˜¤ REST API í‚¤ë¥¼ ì—¬ê¸°ì— ì…ë ¥í•´ì•¼ ë³‘ì› ê²€ìƒ‰ì´ ì‘ë™í•©ë‹ˆë‹¤.
KAKAO_REST_API_KEY = "ì—¬ê¸°ì—_ì¹´ì¹´ì˜¤_REST_API_í‚¤_ì…ë ¥"  # â† ì§ì ‘ ìˆ˜ì •í•˜ì„¸ìš”


# ======================================
# 1. í°íŠ¸(BakDahyun.woff2) + ì „ì—­ ìŠ¤íƒ€ì¼
# ======================================
font_css = ""
try:
    with open("BakDahyn.woff2", "rb") as f:
        font_bytes = f.read()
    font_b64 = base64.b64encode(font_bytes).decode()
    font_css = f"""
    @font-face {{
        font-family: 'BakDahyun';
        src: url(data:font/woff2;base64,{font_b64}) format('woff2');
        font-weight: normal;
        font-style: normal;
    }}
    html, body, [class*="css"] {{
        font-family: 'BakDahyun', sans-serif !important;
    }}
    """
except Exception:
    # í°íŠ¸ íŒŒì¼ ëª» ì°¾ìœ¼ë©´ ê¸°ë³¸ í°íŠ¸
    font_css = """
    html, body, [class*="css"] {
        font-family: sans-serif;
    }
    """

GLOBAL_STYLE = f"""
<style>
{font_css}

/* ì „ì²´ ë°°ê²½ìƒ‰ */
body, .main, [data-testid="stAppViewContainer"],
[data-testid="stAppViewContainer"] > .main,
.block-container {{
    background-color: #FEF7EB !important;
}}

/* ì‚¬ì´ë“œë°” ë°°ê²½ìƒ‰ */
[data-testid="stSidebar"] {{
    background-color: #F3E8DD !important;
}}

/* ì œëª© ìƒ‰ */
h1, h2, h3, h4, h5 {{
    color: #4A332D !important;
}}

/* ì¼ë°˜ í…ìŠ¤íŠ¸ ìƒ‰ */
p, li, span, label {{
    color: #4A332D !important;
}}

/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì½”ë„í†¤) */
.stButton > button {{
    background-color: #E6B59D !important;
    color: #4A332D !important;
    border-radius: 10px;
    border: none;
    padding: 0.5rem 1.2rem;
    font-size: 1rem;
}}
.stButton > button:hover {{
    background-color: #D8C4B6 !important;
    color: #3A2920 !important;
}}

/* ì…ë ¥ì°½, í…ìŠ¤íŠ¸ì˜ì—­, ì…€ë ‰íŠ¸ë°•ìŠ¤ ë°°ê²½ */
input, textarea {{
    background-color: #FEF7EB !important;
    color: #4A332D !important;
    border-radius: 8px !important;
}}
div[data-baseweb="select"] > div {{
    background-color: #FEF7EB !important;
    border-radius: 8px !important;
}}

/* ë¼ë””ì˜¤/ì²´í¬ë°•ìŠ¤ í¬ì¸íŠ¸ ì»¬ëŸ¬ */
input[type="radio"], input[type="checkbox"] {{
    accent-color: #E6B59D !important;
}}

/* ë°ì´í„°í”„ë ˆì„ ì¹´ë“œ */
[data-testid="stDataFrame"] {{
    border-radius: 10px !important;
}}

/* ìŠ¤í¬ë¡¤ë°” */
::-webkit-scrollbar-thumb {{
    background-color: #E6B59D !important;
    border-radius: 10px;
}}
</style>
"""
st.markdown(GLOBAL_STYLE, unsafe_allow_html=True)


# ======================================
# 2. ì„¸ì…˜ ìƒíƒœ
# ======================================
if "records" not in st.session_state:
    st.session_state.records = []

if "food_db" not in st.session_state:
    st.session_state.food_db = {
        "ë‹­ê°€ìŠ´ì‚´": {"ê°€ëŠ¥": "ì†ŒëŸ‰ ì‚¶ì•„ì„œ ê°€ëŠ¥", "ì£¼ì˜": "ì–‘ë…Â·ì†Œê¸ˆ ì—†ì´ ì£¼ì„¸ìš”."},
        "ì†Œê³ ê¸°": {"ê°€ëŠ¥": "ê¸°ë¦„ ì ì€ ë¶€ìœ„ë¥¼ ì˜ ìµí˜€ ì†ŒëŸ‰ ê°€ëŠ¥", "ì£¼ì˜": "ì–‘ë…, ê¸°ë¦„ ë§ì€ ë¶€ìœ„ëŠ” í”¼í•˜ê¸°."},
        "ë¼ì§€ê³ ê¸°": {"ê°€ëŠ¥": "ì¶©ë¶„íˆ ìµíŒ ì‚´ì½”ê¸°ë§Œ ì†ŒëŸ‰ ê°€ëŠ¥", "ì£¼ì˜": "ì§€ë°©Â·ì–‘ë…ì´ ë§ì€ ë¶€ìœ„ëŠ” ì†Œí™” ë¶€ë‹´."},
        "ì—°ì–´": {"ê°€ëŠ¥": "ìµíŒ ì—°ì–´ë§Œ ê°„ì‹ ìˆ˜ì¤€ìœ¼ë¡œ ê°€ëŠ¥", "ì£¼ì˜": "ìƒì—°ì–´Â·í›ˆì œÂ·ì–‘ë… ì—°ì–´ëŠ” ê¸ˆì§€."},
        "ì‚¬ê³¼": {"ê°€ëŠ¥": "ì”¨ì™€ ì‹¬ì„ ì œê±°í•œ ê³¼ìœ¡ë§Œ ì†ŒëŸ‰ ê°€ëŠ¥", "ì£¼ì˜": "ì”¨Â·ì‹¬ì—ëŠ” ë…ì„± ì„±ë¶„ì´ ìˆì–´ ì œê±° í•„ìˆ˜."},
        "ìˆ˜ë°•": {"ê°€ëŠ¥": "ì”¨ì™€ ê»ì§ˆì„ ì œê±°í•œ ê³¼ìœ¡ë§Œ ì†ŒëŸ‰ ê°€ëŠ¥", "ì£¼ì˜": "ê³¼ë‹¹ ë•Œë¬¸ì— ë„ˆë¬´ ìì£¼Â·ë§ì´ ì£¼ì§€ ì•Šê¸°."},
        "ê³ êµ¬ë§ˆ": {"ê°€ëŠ¥": "ì˜ ìµíŒ ê³ êµ¬ë§ˆë¥¼ ì†ŒëŸ‰ ê°„ì‹ìœ¼ë¡œ ê°€ëŠ¥", "ì£¼ì˜": "ë‹¹ë¶„ì´ ë§ì•„ ë¹„ë§ŒÂ·ë‹¹ë‡¨ ì‹œ ì£¼ì˜."},
        "ë¸Œë¡œì½œë¦¬": {"ê°€ëŠ¥": "ì‚¶ì•„ì„œ ì†ŒëŸ‰ ê°€ëŠ¥", "ì£¼ì˜": "ë‚ ë¡œ ë§ì´ ë¨¹ì´ë©´ ê°€ìŠ¤ ìœ ë°œ ê°€ëŠ¥ì„±."},
        "ìš°ìœ ": {"ê°€ëŠ¥": "ê³ ì–‘ì´ ì „ìš© ë½í† í”„ë¦¬ ìš°ìœ ë§Œ ì†ŒëŸ‰ ê°€ëŠ¥", "ì£¼ì˜": "ì¼ë°˜ ìš°ìœ ëŠ” ì„¤ì‚¬ ìœ ë°œ ê°€ëŠ¥ì„±ì´ í¼."},
        "ìš”ê±°íŠ¸": {"ê°€ëŠ¥": "ë¬´ê°€ë‹¹ í”Œë ˆì¸ë§Œ ì•„ì£¼ ì†ŒëŸ‰ ê°€ëŠ¥", "ì£¼ì˜": "ì„¤íƒ•Â·í–¥ë£ŒÂ·ìì¼ë¦¬í†¨ í¬í•¨ ì œí’ˆì€ ê¸ˆì§€."},
        "ì´ˆì½œë¦¿": {"ê°€ëŠ¥": "ë¶ˆê°€", "ì£¼ì˜": "ì¹´ì¹´ì˜¤ ì„±ë¶„(í…Œì˜¤ë¸Œë¡œë¯¼) ë…ì„±. ì†ŒëŸ‰ë„ ìœ„í—˜."},
        "ì–‘íŒŒ": {"ê°€ëŠ¥": "ë¶ˆê°€", "ì£¼ì˜": "ì í˜ˆêµ¬ íŒŒê´´ â†’ ë¹ˆí˜ˆ ìœ ë°œ. ì–´ë–¤ í˜•íƒœë„ ê¸ˆì§€."},
        "ë§ˆëŠ˜": {"ê°€ëŠ¥": "ë¶ˆê°€", "ì£¼ì˜": "ì–‘íŒŒì™€ ë¹„ìŠ·í•œ ë…ì„±. ì•„ì£¼ ì†ŒëŸ‰ë„ ê¸ˆì§€."},
        "í¬ë„": {"ê°€ëŠ¥": "ë¶ˆê°€", "ì£¼ì˜": "ì›ì¸ ë¶ˆëª… ì‹ ì¥ ì†ìƒ ê°€ëŠ¥ì„±. ì™„ì „ ê¸ˆì§€."},
        "ê±´í¬ë„": {"ê°€ëŠ¥": "ë¶ˆê°€", "ì£¼ì˜": "í¬ë„ì™€ ë™ì¼í•˜ê²Œ ì‹ ì¥ ì†ìƒ ìœ„í—˜."},
        "ì»¤í”¼": {"ê°€ëŠ¥": "ë¶ˆê°€", "ì£¼ì˜": "ì¹´í˜ì¸ ë…ì„±. ì‚¬ëŒ ê¸°ì¤€ ì†ŒëŸ‰ë„ ê³ ì–‘ì´ì—ê² ìœ„í—˜."},
        "ì•Œì½”ì˜¬": {"ê°€ëŠ¥": "ë¶ˆê°€", "ì£¼ì˜": "ì‘ì€ ì–‘ë„ ìœ„í—˜. ì ˆëŒ€ ê¸ˆì§€."},
    }


def add_record(rec: dict):
    st.session_state.records.append(rec)


def get_records_df():
    if not st.session_state.records:
        return pd.DataFrame()
    return pd.DataFrame(st.session_state.records)


# ======================================
# 3. ê±´ê°• ê¸°ë¡
# ======================================
def page_health_log():
    st.title("â™§ ê±´ê°• ê¸°ë¡")

    col1, col2 = st.columns(2)

    with col1:
        rec_date = st.date_input("ê¸°ë¡ ë‚ ì§œ", value=date.today())

        meal = st.radio(
            "ì‹ì‚¬ëŸ‰",
            ["ê±°ì˜ ì•ˆ ë¨¹ìŒ", "ì ê²Œ", "ë³´í†µ", "ë§ì´"],
            index=2,
        )

        water = st.radio(
            "ìŒìˆ˜ëŸ‰",
            ["ê±°ì˜ ì•ˆ ë§ˆì‹¬", "ì ê²Œ", "ë³´í†µ", "ë§ì´"],
            index=2,
        )

        poop = st.radio(
            "ë°°ë³€ ìƒíƒœ",
            ["ì •ìƒ", "ë‹¨ë‹¨í•¨", "ì„¤ì‚¬", "í˜ˆë³€", "ì•ˆ ë´„"],
            index=0,
        )

    with col2:
        activity = st.multiselect(
            "í™œë™ ë° í–‰ë™",
            [
                "ë³´í†µ",
                "ì ì´ ë§ì•„ì§",
                "í™œë™ ê°ì†Œ",
                "í™œë™ ì¦ê°€",
                "ì˜ˆë¯¼/ê³µê²©ì ",
                "ìˆ¨ëŠ” ì‹œê°„ì´ ëŠ˜ì–´ë‚¨",
                "ì•¼ì˜¹ê±°ë¦¼ ì¦ê°€",
            ],
            default=["ë³´í†µ"],
        )

        symptoms = st.multiselect(
            "ì´ìƒì¦ì„¸",
            [
                "êµ¬í† ",
                "ê¸°ì¹¨",
                "í˜¸í¡ ì´ìƒ",
                "ì ˆëšê±°ë¦¼",
                "ëˆˆ/ì½” ë¶„ë¹„ë¬¼",
                "ê°€ë ¤ì›€/ê³¼ë„ ê·¸ë£¨ë°",
                "ê¸°íƒ€",
            ],
        )

        vomit_color = ""
        vomit_type = ""
        if "êµ¬í† " in symptoms:
            st.markdown("#### â€  êµ¬í†  ìƒì„¸ ê¸°ë¡")
            vomit_color = st.selectbox(
                "êµ¬í†  ìƒ‰",
                ["ì„ íƒ ì•ˆ í•¨", "íˆ¬ëª…/ê±°í’ˆ", "ë…¸ë€ìƒ‰(ë‹´ì¦™)", "ê°ˆìƒ‰/ì‚¬ë£Œ", "ë¶‰ì€ìƒ‰/ë¶„í™ìƒ‰", "ê¸°íƒ€"],
            )
            vomit_type = st.selectbox(
                "êµ¬í†  ë‚´ìš©ë¬¼",
                ["ì„ íƒ ì•ˆ í•¨", "í—¤ì–´ë³¼", "ì‚¬ë£Œ ì¡°ê°", "ê±°í’ˆ/ì•¡ì²´", "ì´ë¬¼ ê°€ëŠ¥ì„±", "ê¸°íƒ€"],
            )

        memo = st.text_area("ë©”ëª¨", placeholder="í™˜ê²½ ë³€í™”, ê°„ì‹, ì•½ ë³µìš© ë“±")

    if st.button("ê¸°ë¡ ì €ì¥"):
        rec = {
            "ë‚ ì§œ": rec_date,
            "ì‹ì‚¬ëŸ‰": meal,
            "ìŒìˆ˜ëŸ‰": water,
            "ë°°ë³€": poop,
            "í–‰ë™": ", ".join(activity) if activity else "",
            "ì´ìƒì¦ì„¸": ", ".join(symptoms) if symptoms else "",
            "êµ¬í†  ìƒ‰": vomit_color,
            "êµ¬í†  ë‚´ìš©": vomit_type,
            "ë©”ëª¨": memo,
        }
        add_record(rec)
        st.success("ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")

    st.markdown("---")
    st.subheader("â™§ ìµœê·¼ ê¸°ë¡")

    df = get_records_df()
    if df.empty:
        st.info("ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.")
    else:
        st.dataframe(df.tail(10), use_container_width=True)


# ======================================
# 4. AI ì§„ë‹¨
# ======================================
def page_ai_diagnosis():
    st.title("â™¤ AI ì§„ë‹¨")

    df = get_records_df()
    if df.empty:
        st.info("ë¨¼ì € â€˜ê±´ê°• ê¸°ë¡â€™ì— ìµœì†Œ 1ê°œ ì´ìƒì˜ ê¸°ë¡ì„ ë‚¨ê²¨ ì£¼ì„¸ìš”.")
        return

    recent = df.tail(7)
    warnings = []
    tips = []

    # ì‹ì‚¬ëŸ‰
    low_meal = recent["ì‹ì‚¬ëŸ‰"].isin(["ê±°ì˜ ì•ˆ ë¨¹ìŒ", "ì ê²Œ"]).sum()
    if low_meal >= 2:
        warnings.append("ìµœê·¼ ë©°ì¹  ê°„ ì‹ì‚¬ëŸ‰ì´ ì¤„ì–´ë“  ë‚ ì´ ì—¬ëŸ¬ ë²ˆ ìˆìŠµë‹ˆë‹¤.")
        tips.append("ì‹ìš• ì €í•˜ëŠ” ë‹¤ì–‘í•œ ì§ˆí™˜ì˜ ì´ˆê¸°ê°€ ë  ìˆ˜ ìˆìœ¼ë‹ˆ 24ì‹œê°„ ì´ìƒ ì§€ì† ì‹œ ë³‘ì› ìƒë‹´ì„ ê¶Œì¥í•©ë‹ˆë‹¤.")

    # ìŒìˆ˜ëŸ‰
    low_water = recent["ìŒìˆ˜ëŸ‰"].isin(["ê±°ì˜ ì•ˆ ë§ˆì‹¬", "ì ê²Œ"]).sum()
    if low_water >= 2:
        warnings.append("ë¬¼ ì„­ì·¨ê°€ ë¶€ì¡±í•œ ë‚ ì´ ë°˜ë³µë˜ê³  ìˆìŠµë‹ˆë‹¤.")
        tips.append("ìš”ë¡œÂ·ì‹ ì¥ ë¬¸ì œ ì˜ˆë°©ì„ ìœ„í•´ ë¬¼ê·¸ë¦‡/ì •ìˆ˜ê¸° ì ê²€ê³¼ ìŠµì‹ ì‚¬ë£Œ í™œìš©ì„ ê³ ë ¤í•´ ë³´ì„¸ìš”.")

    # ë°°ë³€
    bad_poop = recent["ë°°ë³€"].isin(["ì„¤ì‚¬", "í˜ˆë³€", "ì•ˆ ë´„"]).sum()
    if bad_poop >= 2:
        warnings.append("ë°°ë³€ ìƒíƒœ ì´ìƒ(ì„¤ì‚¬/í˜ˆë³€/ë°°ë³€ ì—†ìŒ)ì´ ì—¬ëŸ¬ ë²ˆ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.")
        tips.append("3ì¼ ì´ìƒ ì§€ì†ë˜ë©´ ë³€ ìƒíƒœ ì‚¬ì§„ê³¼ í•¨ê»˜ ë³‘ì› ì§„ë£Œë¥¼ ë°›ëŠ” ê²ƒì´ ì•ˆì „í•©ë‹ˆë‹¤.")

    # í–‰ë™
    if "í–‰ë™" in recent.columns:
        low_act = recent["í–‰ë™"].str.contains("í™œë™ ê°ì†Œ|ì ì´ ë§ì•„ì§|ìˆ¨ëŠ” ì‹œê°„ì´ ëŠ˜ì–´ë‚¨", na=False).sum()
        if low_act >= 2:
            warnings.append("ë¬´ê¸°ë ¥í•˜ê±°ë‚˜ ìˆ¨ì–´ ì§€ë‚´ëŠ” íŒ¨í„´ì´ ë°˜ë³µë˜ê³  ìˆìŠµë‹ˆë‹¤.")
            tips.append("í™œë™ ê°ì†Œ + ì‹ìš• ì €í•˜ê°€ í•¨ê»˜ ë³´ì´ë©´ ë” ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.")

    # êµ¬í† 
    if "ì´ìƒì¦ì„¸" in recent.columns:
        vomit_days = recent["ì´ìƒì¦ì„¸"].str.contains("êµ¬í† ", na=False).sum()
        if vomit_days >= 2:
            warnings.append("ì¼ì£¼ì¼ ì•ˆì— â€˜êµ¬í† â€™ê°€ ì—¬ëŸ¬ ë²ˆ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.")
            tips.append("í—¤ì–´ë³¼, ì‚¬ë£Œ, ì¥ ë¬¸ì œ ë“± ì›ì¸ì´ ë‹¤ì–‘í•˜ë‹ˆ í† í•œ ë‚´ìš©ë¬¼ê³¼ íšŸìˆ˜ë¥¼ ê¸°ë¡í•´ ë‘ë©´ ë„ì›€ì´ ë©ë‹ˆë‹¤.")

    if "êµ¬í†  ìƒ‰" in recent.columns:
        blood_like = recent["êµ¬í†  ìƒ‰"].str.contains("ë¶‰ì€ìƒ‰|ë¶„í™", na=False).sum()
        if blood_like >= 1:
            warnings.append("ë¶‰ì€ìƒ‰Â·ë¶„í™ìƒ‰ êµ¬í† ê°€ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ˆì„± êµ¬í†  ê°€ëŠ¥ì„±ì´ ìˆì–´ ì¦‰ì‹œ ë³‘ì› ì§„ë£Œê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

    if not warnings:
        st.success("ìµœê·¼ ê¸°ë¡ì—ì„œ ëšœë ·í•œ ìœ„í—˜ ì‹ í˜¸ëŠ” í¬ê²Œ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        st.write("ê·¸ë˜ë„ ì‘ì€ ë³€í™”ê°€ ìŒ“ì—¬ ì´ìƒìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìœ¼ë‹ˆ ê¾¸ì¤€íˆ ê¸°ë¡í•´ ì£¼ì„¸ìš”.")
    else:
        st.subheader("â€  ì£¼ì˜ê°€ í•„ìš”í•œ ë³€í™”")
        for w in warnings:
            st.warning("- " + w)

    if tips:
        st.subheader("Â£ ì°¸ê³ í•˜ë©´ ì¢‹ì€ íŒ")
        for t in tips:
            st.write("- " + t)

    with st.expander("ìµœê·¼ 7ê°œ ê¸°ë¡ ë³´ê¸°"):
        st.dataframe(recent, use_container_width=True)


# ======================================
# 5. ì‘ê¸‰ìƒí™© AI (+ ì¹´ì¹´ì˜¤ë§µ ë³‘ì› ê²€ìƒ‰)
# ======================================
def search_animal_hospitals_kakao(keyword_region: str):
    """ì¹´ì¹´ì˜¤ APIë¡œ ì£¼ì†Œâ†’ì¢Œí‘œâ†’ì£¼ë³€ ë™ë¬¼ë³‘ì› ê²€ìƒ‰"""
    if not KAKAO_REST_API_KEY or "ì—¬ê¸°ì—_ì¹´ì¹´ì˜¤" in KAKAO_REST_API_KEY:
        st.error("ì¹´ì¹´ì˜¤ REST API í‚¤ë¥¼ ë¨¼ì € ì½”ë“œ ìƒë‹¨ KAKAO_REST_API_KEYì— ì…ë ¥í•´ ì£¼ì„¸ìš”.")
        return None, None

    headers = {"Authorization": f"KakaoAK {KAKAO_REST_API_KEY}"}

    # 1) ì£¼ì†Œ ê²€ìƒ‰ìœ¼ë¡œ ì¤‘ì‹¬ ì¢Œí‘œ ì–»ê¸°
    addr_url = "https://dapi.kakao.com/v2/local/search/address.json"
    addr_params = {"query": keyword_region}
    addr_res = requests.get(addr_url, headers=headers, params=addr_params)
    if addr_res.status_code != 200:
        st.error("ì£¼ì†Œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
        return None, None

    addr_docs = addr_res.json().get("documents", [])
    if not addr_docs:
        st.warning("í•´ë‹¹ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜ˆ: 'ì„œìš¸ ê°•ë‚¨êµ¬', 'ë¶€ì‚° í•´ìš´ëŒ€êµ¬' ë“±ìœ¼ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
        return None, None

    x = float(addr_docs[0]["x"])  # ê²½ë„
    y = float(addr_docs[0]["y"])  # ìœ„ë„

    # 2) ì£¼ë³€ ë™ë¬¼ë³‘ì› ê²€ìƒ‰ (ë°˜ê²½ 5km)
    keyword_url = "https://dapi.kakao.com/v2/local/search/keyword.json"
    params = {
        "query": "ë™ë¬¼ë³‘ì›",
        "x": x,
        "y": y,
        "radius": 5000,
        "size": 10,
        "sort": "distance",
    }
    res = requests.get(keyword_url, headers=headers, params=params)
    if res.status_code != 200:
        st.error("ë™ë¬¼ë³‘ì›ì„ ê²€ìƒ‰í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
        return None, None

    docs = res.json().get("documents", [])
    if not docs:
        st.info("ì£¼ë³€ 5km ì´ë‚´ ë™ë¬¼ë³‘ì›ì´ ê²€ìƒ‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        return None, None

    # ì§€ë„ìš© DF, í‘œìš© DF ìƒì„±
    map_data = []
    table_data = []
    for d in docs:
        lat = float(d["y"])
        lon = float(d["x"])
        name = d["place_name"]
        addr = d.get("road_address_name") or d.get("address_name")
        phone = d.get("phone", "")
        map_data.append({"lat": lat, "lon": lon})
        table_data.append({"ì´ë¦„": name, "ì£¼ì†Œ": addr, "ì „í™”ë²ˆí˜¸": phone})

    return pd.DataFrame(map_data), pd.DataFrame(table_data)


def page_ai_emergency():
    st.title("â€  ì‘ê¸‰ìƒí™© AI")

    # ---------------- ì§€ë„ + ë³‘ì›ê²€ìƒ‰ ì„¹ì…˜ ----------------
    st.subheader("â™§ ê·¼ì²˜ ë™ë¬¼ë³‘ì› ì°¾ê¸°")
    region = st.text_input("ì£¼ì†Œ ë˜ëŠ” ë™ë„¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš” (ì˜ˆ: ì„œìš¸ ê°•ë‚¨êµ¬, ë¶€ì‚° í•´ìš´ëŒ€êµ¬ ë“±).", key="region_input")
    search_clicked = st.button("ë™ë¬¼ë³‘ì› ê²€ìƒ‰")

    if search_clicked:
        if not region.strip():
            st.warning("ë¨¼ì € ì£¼ì†Œë‚˜ ë™ë„¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
        else:
            map_df, table_df = search_animal_hospitals_kakao(region.strip())
            if map_df is not None and table_df is not None:
                st.map(map_df, zoom=11)
                st.markdown("Â£ ê²€ìƒ‰ëœ ë™ë¬¼ë³‘ì› ëª©ë¡")
                st.dataframe(table_df, use_container_width=True)

    st.markdown("---")

    # ---------------- ìƒí™©ë³„ ì‘ê¸‰ ê°€ì´ë“œ ----------------
    mode = st.selectbox(
        "ìƒí™© ì¢…ë¥˜ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.",
        ["ì„ íƒí•˜ì„¸ìš”", "ê±´ê°• ê´€ë ¨ ì‘ê¸‰", "ì‹¬íì†Œìƒìˆ  ê°œë…", "í™”ì¬/ì§€ì§„ ë“± ì¬ë‚œ ìƒí™©", "ê³ ì–‘ì´ ì‹¤ì¢…/ê°€ì¶œ"],
    )

    if mode == "ê±´ê°• ê´€ë ¨ ì‘ê¸‰":
        st.subheader("â™§ ê±´ê°• ê´€ë ¨ ì‘ê¸‰ìƒí™©")
        sym = st.selectbox(
            "ì£¼ ì¦ìƒì„ ì„ íƒí•´ ì£¼ì„¸ìš”.",
            ["ì„ íƒí•˜ì„¸ìš”", "ë°˜ë³µ êµ¬í† ", "ì§€ì† ì„¤ì‚¬/í˜ˆë³€", "í˜¸í¡ ê³¤ë€", "ê°‘ì‘ìŠ¤ëŸ¬ìš´ ë¬´ê¸°ë ¥", "ì™¸ìƒ/ì¶œí˜ˆ"],
        )
        if st.button("ì‘ê¸‰ ê°€ì´ë“œ ë³´ê¸°"):
            if sym == "ë°˜ë³µ êµ¬í† ":
                st.write("- ì‚¬ë£Œì™€ ë¬¼ì„ ì ì‹œ ì¹˜ìš°ê³ , êµ¬í†  íšŸìˆ˜Â·ë‚´ìš©ë¬¼ì„ ê¸°ë¡í•´ ì£¼ì„¸ìš”.")
                st.write("- í•˜ë£¨ ì´ìƒ ë°˜ë³µë˜ë©´ 24ì‹œ ë™ë¬¼ë³‘ì› ë¬¸ì˜ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.")
            elif sym == "ì§€ì† ì„¤ì‚¬/í˜ˆë³€":
                st.write("- ì‚¬ëŒìš© ì§€ì‚¬ì œëŠ” ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.")
                st.write("- ë³€ì˜ ìƒ‰Â·ëª¨ì–‘Â·íšŸìˆ˜ë¥¼ ê¸°ë¡í•˜ê³  ì‚¬ì§„ì„ ë‚¨ê²¨ ë‘ë©´ ì§„ë£Œì— ë„ì›€ì´ ë©ë‹ˆë‹¤.")
            elif sym == "í˜¸í¡ ê³¤ë€":
                st.error("ì…ì„ ë²Œë¦¬ê³  í—ë–¡ì´ê±°ë‚˜ í˜€Â·ì‡ëª¸ì´ íŒŒë—ê²Œ ë³´ì´ë©´ **ë§¤ìš° ìœ„ê¸‰í•œ ìƒí™©**ì…ë‹ˆë‹¤. ì¦‰ì‹œ ì‘ê¸‰ ë³‘ì›ìœ¼ë¡œ ì´ë™í•´ì•¼ í•©ë‹ˆë‹¤.")
            elif sym == "ê°‘ì‘ìŠ¤ëŸ¬ìš´ ë¬´ê¸°ë ¥":
                st.write("- ì²´ì˜¨(ë„ˆë¬´ ëœ¨ê²ê±°ë‚˜ ì°¨ê°‘ì§€ ì•Šì€ì§€), í˜¸í¡ ìˆ˜, ì‡ëª¸ ìƒ‰ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.")
                st.write("- ë¨¹ì§€ë„, ì›€ì§ì´ì§€ë„ ì•Šìœ¼ë©´ ë°”ë¡œ ë³‘ì› ìƒë‹´ì´ í•„ìš”í•©ë‹ˆë‹¤.")
            elif sym == "ì™¸ìƒ/ì¶œí˜ˆ":
                st.write("- ê¹¨ë—í•œ ê±°ì¦ˆë‚˜ ì²œìœ¼ë¡œ ìƒì²˜ ë¶€ìœ„ë¥¼ ë¶€ë“œëŸ½ê²Œ ì••ë°•í•´ ì§€í˜ˆì„ ì‹œë„í•©ë‹ˆë‹¤.")
                st.write("- í° ì¶œí˜ˆÂ·ì ˆëšê±°ë¦¼ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ë³‘ì›ìœ¼ë¡œ ì´ë™í•´ì•¼ í•©ë‹ˆë‹¤.")

    elif mode == "ì‹¬íì†Œìƒìˆ  ê°œë…":
        st.subheader("â€  ë°˜ë ¤ë™ë¬¼ ì‹¬íì†Œìƒìˆ  (ì›ë¦¬ ì†Œê°œ)")
        st.write("- ì˜ì‹ê³¼ í˜¸í¡, ë§¥ë°•ì´ ìˆëŠ”ì§€ ë¨¼ì € í™•ì¸í•©ë‹ˆë‹¤.")
        st.write("- í˜¸í¡ê³¼ ë§¥ë°•ì´ ëª¨ë‘ ì—†ì„ ë•Œì—ë§Œ ì‹¬íì†Œìƒìˆ ì„ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤.")
        st.write("- ì‘ì€ ê³ ì–‘ì´ëŠ” í•œ ì† í˜¹ì€ ë‘ ì†ê°€ë½ìœ¼ë¡œ ê°€ìŠ´ì„ ì••ë°•í•˜ë©° ë¶„ë‹¹ 100~120íšŒ ì •ë„ì˜ ì†ë„ë¡œ ì‹œí–‰í•©ë‹ˆë‹¤.")
        st.info("ì‹¤ì œ ìƒí™©ì—ì„œëŠ” 24ì‹œ ë™ë¬¼ë³‘ì›ê³¼ í†µí™”í•˜ë©° ì•ˆë‚´ë¥¼ ë°›ëŠ” ê²ƒì´ ê°€ì¥ ì•ˆì „í•©ë‹ˆë‹¤.")

    elif mode == "í™”ì¬/ì§€ì§„ ë“± ì¬ë‚œ ìƒí™©":
        st.subheader("â€  í™”ì¬/ì§€ì§„ ë“± ì¬ë‚œ ìƒí™© ì‹œ ëŒ€ì²˜")
        st.write("- ì´ë™ì¥ì„ í•­ìƒ ëˆˆì— ë„ëŠ” ê³³ì— ë‘ê³ , ê³ ì–‘ì´ê°€ í‰ì†Œì— ë“¤ì–´ê°€ ìµìˆ™í•´ì§€ë„ë¡ í•´ ì£¼ì„¸ìš”.")
        st.write("- í™”ì¬ ì‹œì—ëŠ” ê³ ì–‘ì´ë¥¼ ì°¾ëŠë¼ ë„ˆë¬´ ì˜¤ë˜ ë¨¸ë¬´ë¥´ê¸°ë³´ë‹¤, ê°€ê¹Œìš´ ê³³ì— ìˆëŠ” ê°œì²´ë¶€í„° ì´ë™ì¥ì— ë„£ì–´ ë¹ ë¥´ê²Œ ëŒ€í”¼í•©ë‹ˆë‹¤.")
        st.write("- ì§€ì§„ ì‹œì—ëŠ” ì°½ë¬¸, ë–¨ì–´ì§ˆ ë¬¼ê±´ ê·¼ì²˜ì—ì„œ ë©€ì–´ì ¸ ê³ ì–‘ì´ì™€ í•¨ê»˜ ë‚®ì€ ìì„¸ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.")

    elif mode == "ê³ ì–‘ì´ ì‹¤ì¢…/ê°€ì¶œ":
        st.subheader("â€  ê³ ì–‘ì´ ì‹¤ì¢…/ê°€ì¶œ ì‹œ ëŒ€ì²˜")
        st.write("- ì‹¤ì¢… ì§í›„, ì§‘ ì£¼ë³€ 50m ì´ë‚´ë¥¼ ì¡°ìš©íˆ ëŒì•„ë³´ë©° ìµìˆ™í•œ ì´ë¦„ìœ¼ë¡œ ë¶ˆëŸ¬ ì£¼ì„¸ìš”.")
        st.write("- ì°¨ ë°‘, ê³„ë‹¨ ì•„ë˜, í™”ë‹¨ ë“± ìˆ¨ê¸° ì¢‹ì€ ê³³ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì‚´í´ë´…ë‹ˆë‹¤.")
        st.write("- ì§‘ ê·¼ì²˜ì— ì‚¬ìš©í•˜ë˜ ë‹´ìš”Â·ëª¨ë˜Â·ë°¥ê·¸ë¦‡ ë“±ì„ ë†“ì•„ ëƒ„ìƒˆë¡œ ëŒì•„ì˜¬ ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.")
        st.write("- ë™ë„¤ ì»¤ë®¤ë‹ˆí‹°, SNS, ì „ë‹¨ì„ í™œìš©í•´ ìœ„ì¹˜Â·ì‹œê°„Â·íŠ¹ì§•ì„ ê³µìœ í•˜ë©´ ë„ì›€ì´ ë©ë‹ˆë‹¤.")


# ======================================
# 6. ì§‘ì‚¬ ê°€ì´ë“œ
# ======================================
def page_guide():
    st.title("Â£ ì§‘ì‚¬ ê°€ì´ë“œ")

    tabs = st.tabs(
        [
            "ê¸°ë³¸ ê°€ì´ë“œ",
            "ì•½ ë¨¹ì´ê¸°",
            "ê²©ë¦¬Â·ì ì‘",
            "ëª©ìš•",
            "ë°œí†± ê´€ë¦¬",
            "ë…¸ë ¹ë¬˜ ê´€ë¦¬",
            "ì¤‘ì„±í™” ì´í›„",
            "ë‹¤ì´ì–´íŠ¸/ì²´ì¤‘ ê´€ë¦¬",
            "ëŒ€í‘œ ì§ˆë³‘ ì§•í›„",
        ]
    )

    with tabs[0]:
        st.write("- ìˆ¨ì„ ìˆ˜ ìˆëŠ” ì•ˆì „í•œ ê³µê°„ì„ ë¨¼ì € ë§ˆë ¨í•´ ì£¼ì„¸ìš”.")
        st.write("- ë°¥Â·ë¬¼Â·í™”ì¥ì‹¤ ìœ„ì¹˜ë¥¼ ìì£¼ ë°”ê¾¸ì§€ ì•ŠëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.")
        st.write("- í™”ì¥ì‹¤ê³¼ ë°¥ê·¸ë¦‡ì€ ì„œë¡œ ë„ˆë¬´ ê°€ê¹ì§€ ì•Šê²Œ ë°°ì¹˜í•´ ì£¼ì„¸ìš”.")
        st.write("- ê°‘ì‘ìŠ¤ëŸ¬ìš´ ì†ŒìŒÂ·ì†ë‹˜ ë°©ë¬¸Â·ì´ì‚¬ ë“±ì€ í° ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

    with tabs[1]:
        st.subheader("ì•½ ë¨¹ì´ê¸°")
        st.write("- ê°€ëŠ¥í•˜ë©´ ì•½ ë¨¹ì´ê¸° ë³´ì¡° ê°„ì‹(í•„ í¬ì¼“ ë“±)ì„ í™œìš©í•´ ì£¼ì„¸ìš”.")
        st.write("- ì•Œì•½ì€ í˜€ ë’¤ìª½ì— ë‘ê³  ì…ì„ ë‹«ì€ ë’¤ ëª©ì„ ì‚´ì§ ì“°ë‹¤ë“¬ìœ¼ë©° ì‚¼í‚¤ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.")
        st.write("- ê°€ë£¨ì•½ì€ ì¢‹ì•„í•˜ëŠ” ìŠµì‹ì— ì•„ì£¼ ì†ŒëŸ‰ ì„ì–´ ë°˜ì‘ì„ ë³´ë©° ì–‘ì„ ì¡°ì ˆí•©ë‹ˆë‹¤.")

    with tabs[2]:
        st.subheader("ê²©ë¦¬Â·ì ì‘")
        st.write("- ìƒˆ ê³ ì–‘ì´ë¥¼ ë“¤ì¼ ë•ŒëŠ” ìµœì†Œ ë©°ì¹ ê°„ ë°©ì„ ë‚˜ëˆ„ì–´ ëƒ„ìƒˆì™€ ì†Œë¦¬ì— ë¨¼ì € ì ì‘ì‹œí‚µë‹ˆë‹¤.")
        st.write("- ë¬¸í‹ˆìœ¼ë¡œ ëƒ„ìƒˆë§Œ ê³µìœ í•˜ê³ , ì§§ì€ ì‹œê°„ì”© ëŒ€ë©´ì„ ì‹œë„í•˜ë©° ì ì°¨ ëŠ˜ë ¤ê°‘ë‹ˆë‹¤.")

    with tabs[3]:
        st.subheader("ëª©ìš•")
        st.write("- í•„ìš”í•  ë•Œë§Œ ì§§ê²Œ í•˜ê³ , ë¯¸ë„ëŸ½ì§€ ì•Šì€ í™˜ê²½ì—ì„œ ì§„í–‰í•´ ì£¼ì„¸ìš”.")
        st.write("- ê³ ì–‘ì´ ì „ìš© ìƒ´í‘¸ë¥¼ ì‚¬ìš©í•˜ê³ , ì¶©ë¶„íˆ ë§ë¦¬ì§€ ì•Šìœ¼ë©´ ê°ê¸°Â·í”¼ë¶€ ë¬¸ì œê°€ ìƒê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

    with tabs[4]:
        st.subheader("ë°œí†± ê´€ë¦¬")
        st.write("- ì²˜ìŒì—ëŠ” í•œë‘ ë°œê°€ë½ë§Œ, ê°„ì‹ê³¼ í•¨ê»˜ ì§§ê²Œ ì—°ìŠµí•´ ë³´ì„¸ìš”.")
        st.write("- ë¶„í™ìƒ‰ í˜ˆê´€ ë¶€ë¶„ì„ í”¼í•´ì„œ ëì˜ ë¾°ì¡±í•œ ë¶€ë¶„ë§Œ ì¡°ê¸ˆì”© ìë¥´ëŠ” ê²ƒì´ ì•ˆì „í•©ë‹ˆë‹¤.")

    with tabs[5]:
        st.subheader("ë…¸ë ¹ë¬˜ ê´€ë¦¬")
        st.write("- ë¨¹ëŠ” ì–‘Â·ë°°ë³€Â·ì í”„ ëŠ¥ë ¥Â·í™œë™ëŸ‰ ë“±ì˜ ì‘ì€ ë³€í™”ë¥¼ ìì£¼ í™•ì¸í•´ ì£¼ì„¸ìš”.")
        st.write("- ê´€ì ˆÂ·ì‹ ì¥Â·ê°‘ìƒì„  ì§ˆí™˜ì´ ëŠ˜ì–´ë‚˜ëŠ” ì‹œê¸°ë¼ ì •ê¸° ê²€ì§„ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.")

    with tabs[6]:
        st.subheader("ì¤‘ì„±í™” ìˆ˜ìˆ  ì´í›„")
        st.write("- ìˆ˜ìˆ  ë¶€ìœ„ë¥¼ í•¥ì§€ ëª»í•˜ë„ë¡ ë„¥ì¹´ë¼ë¥¼ ì°©ìš©í•©ë‹ˆë‹¤.")
        st.write("- ìƒì²˜ ë¶€ìœ„ê°€ ë¶‰ê²Œ ë¶“ê±°ë‚˜ ë¶„ë¹„ë¬¼ì´ ë³´ì´ë©´ ë°”ë¡œ ë³‘ì›ì— ë¬¸ì˜í•˜ì„¸ìš”.")
        st.write("- ì¤‘ì„±í™” ì´í›„ì—ëŠ” ëŒ€ì‚¬ëŸ‰ì´ ì¤„ì–´ ì‚´ì´ ì°Œê¸° ì‰¬ìš°ë¯€ë¡œ ì‚¬ë£Œ ì–‘ì„ ì¡°ì ˆí•´ ì£¼ì„¸ìš”.")

    with tabs[7]:
        st.subheader("ë‹¤ì´ì–´íŠ¸ / ì²´ì¤‘ ê´€ë¦¬")
        st.write("- ë¬´ì‘ì • ì–‘ì„ ì¤„ì´ê¸°ë³´ë‹¤ëŠ” ì €ì¹¼ë¡œë¦¬Â·ë‹¤ì´ì–´íŠ¸ìš© ì‚¬ë£Œë¡œ ì²œì²œíˆ ì „í™˜í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.")
        st.write("- í•˜ë£¨ ê¸‰ì—¬ëŸ‰ì„ 2~3íšŒë¡œ ë‚˜ëˆ„ì–´ ì£¼ë©´ í­ì‹ê³¼ êµ¬í† ë¥¼ ì¤„ì´ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.")

    with tabs[8]:
        st.subheader("ëŒ€í‘œ ì§ˆë³‘ ì§•í›„")
        st.write("- ë°©ê´‘ì—¼/ìš”ë¡œê³„: í™”ì¥ì‹¤ì„ ìì£¼ ë“¤ë½ê±°ë¦¬ê±°ë‚˜ ì†Œë³€ ì–‘ì´ ì¤„ê³  í˜ˆë‡¨ê°€ ë³´ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
        st.write("- ì¥ ë¬¸ì œ: ì§€ì†ì ì¸ ì„¤ì‚¬Â·êµ¬í† Â·ì‹ìš• ì €í•˜Â·ì²´ì¤‘ ê°ì†Œ ë“±ì´ ë™ë°˜ë©ë‹ˆë‹¤.")
        st.write("- êµ¬ê°• ë¬¸ì œ: ì… ëƒ„ìƒˆ, ì¹¨ í˜ë¦¼, ë”±ë”±í•œ ì‚¬ë£Œë¥¼ ì”¹ê¸° ì–´ë ¤ì›Œí•˜ëŠ” ëª¨ìŠµì´ ë³´ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")


# ======================================
# 7. ìŒì‹ ì‚¬ì „
# ======================================
def page_food_dict():
    st.title("Â¢ ìŒì‹ ì‚¬ì „")

    food_db = st.session_state.food_db

    col1, col2 = st.columns([3, 1])
    with col1:
        query = st.text_input("ì‚¬ëŒ ìŒì‹ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”. (ì˜ˆ: ì–‘íŒŒ, ì‚¬ê³¼, ì´ˆì½œë¦¿ ë“±)", key="food_query")
    with col2:
        search_clicked = st.button("ê²€ìƒ‰")

    st.markdown("<br>", unsafe_allow_html=True)

    if search_clicked:
        name = (st.session_state.food_query or "").strip()
        if not name:
            st.warning("ë¨¼ì € ìŒì‹ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
        elif name in food_db:
            info = food_db[name]
            if info["ê°€ëŠ¥"] == "ë¶ˆê°€":
                st.error(f"âŒ {name} : ê³ ì–‘ì´ì—ê²Œ **ì ˆëŒ€ ê¸‰ì—¬í•˜ë©´ ì•ˆ ë˜ëŠ” ìŒì‹**ì…ë‹ˆë‹¤.")
            else:
                st.success(f"â­• {name} : {info['ê°€ëŠ¥']}")
            st.write("ì£¼ì˜ì‚¬í•­:")
            st.write("- " + info["ì£¼ì˜"])
        else:
            st.warning(f"'{name}' ì— ëŒ€í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
            st.write("ë°˜ë“œì‹œ ìˆ˜ì˜ì‚¬ë‚˜ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ìë£Œë¥¼ í†µí•´ ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸í•´ ì£¼ì„¸ìš”.")

    with st.expander("í˜„ì¬ ë“±ë¡ëœ ìŒì‹ ëª©ë¡ ë³´ê¸°"):
        df_food = pd.DataFrame(
            [
                {"ìŒì‹": k, "ê¸‰ì—¬ ê°€ëŠ¥/ì¡°ê±´": v["ê°€ëŠ¥"], "ì£¼ì˜ì‚¬í•­": v["ì£¼ì˜"]}
                for k, v in food_db.items()
            ]
        )
        st.dataframe(df_food, use_container_width=True)


# ======================================
# 8. ë§ˆì¼“
# ======================================
def page_market():
    st.title("â™¤ ë¬˜ë©˜íŠ¸ ë§ˆì¼“")

    df = get_records_df()
    if df.empty:
        st.info("ìµœê·¼ ê±´ê°• ê¸°ë¡ì´ ì—†ì–´ ê¸°ë³¸ ì¶”ì²œë§Œ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤.")
        state = "ì •ë³´ ë¶€ì¡±"
    else:
        last = df.iloc[-1]
        state = "ì „ë°˜ì ìœ¼ë¡œ ì–‘í˜¸"
        if last["ë°°ë³€"] in ["ì„¤ì‚¬", "í˜ˆë³€"]:
            state = "ì¥ ê±´ê°• ë¯¼ê°"
        elif last["ìŒìˆ˜ëŸ‰"] in ["ê±°ì˜ ì•ˆ ë§ˆì‹¬", "ì ê²Œ"]:
            state = "ìˆ˜ë¶„ ì„­ì·¨ ë¶€ì¡±"
        elif last["ì‹ì‚¬ëŸ‰"] in ["ê±°ì˜ ì•ˆ ë¨¹ìŒ", "ì ê²Œ"]:
            state = "ì‹ìš• ì €í•˜ ê°€ëŠ¥"

    st.subheader(f"í˜„ì¬ ìƒíƒœ (ê°„ë‹¨ ì¶”ì •): {state}")

    st.markdown("---")
    st.subheader("ì¶”ì²œ ì‚¬ë£Œ/ê°„ì‹ íƒ€ì…")

    if state == "ì¥ ê±´ê°• ë¯¼ê°":
        st.write("- ì†Œí™”ê°€ ì˜ ë˜ëŠ” ì €ìê·¹ ì‚¬ë£Œ")
        st.write("- ìœ ì‚°ê· ì´ í¬í•¨ëœ ì‚¬ë£Œ/ê°„ì‹")
        st.write("- ê°‘ì‘ìŠ¤ëŸ¬ìš´ ì‚¬ë£Œ ë³€ê²½ì€ í”¼í•˜ê³  ì„œì„œíˆ ë°”ê¾¸ê¸°")
    elif state == "ìˆ˜ë¶„ ì„­ì·¨ ë¶€ì¡±":
        st.write("- ìˆ˜ë¶„ í•¨ëŸ‰ì´ ë†’ì€ ìŠµì‹ ì‚¬ë£Œ")
        st.write("- ë¬¼ ì„­ì·¨ë¥¼ ìœ ë„í•˜ëŠ” êµ­ë¬¼Â·ì¸„ë¥´ í˜•íƒœ ê°„ì‹")
        st.write("- ìë™ ê¸‰ìˆ˜ê¸°(ë¶„ìˆ˜í˜•) ì‚¬ìš©ë„ ë„ì›€ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    elif state == "ì‹ìš• ì €í•˜ ê°€ëŠ¥":
        st.write("- í–¥ì´ ê°•í•œ ìŠµì‹ ì‚¬ë£Œì™€ ì¸„ë¥´ë¥¼ ì†ŒëŸ‰ì”© ìì£¼ ê¸‰ì—¬")
        st.write("- ì‹ì‚¬ í™˜ê²½(ì†ŒìŒ, ìŠ¤íŠ¸ë ˆìŠ¤ ìš”ì¸ ë“±)ì„ ì ê²€í•´ ë³´ì„¸ìš”.")
    else:
        st.write("- ì—°ë ¹Â·ì¤‘ì„±í™” ì—¬ë¶€ì— ë§ì¶˜ ê· í˜•í˜• ì‚¬ë£Œ")
        st.write("- ë¹„ë§Œ ë°©ì§€ë¥¼ ìœ„í•´ ì¹¼ë¡œë¦¬ ê³¼ë‹¤í•œ ê°„ì‹ì€ í”¼í•˜ê¸°")

    st.info("ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ì‡¼í•‘ëª°ê³¼ ì—°ë™í•´ êµ¬ì²´ì ì¸ ìƒí’ˆê¹Œì§€ ì¶”ì²œí•˜ë„ë¡ í™•ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")


# ======================================
# 9. ë¼ìš°íŒ…
# ======================================
menu = st.sidebar.radio(
    "ë©”ë‰´",
    ["í™ˆ", "ê±´ê°• ê¸°ë¡", "AI ì§„ë‹¨", "ì§‘ì‚¬ ê°€ì´ë“œ", "ì‘ê¸‰ìƒí™© AI", "ìŒì‹ ì‚¬ì „", "ë§ˆì¼“"],
)

if menu == "í™ˆ":
    try:
        st.image("banner.png", use_column_width=True)
    except Exception:
        st.title("â™§ ë¬˜ë©˜íŠ¸")
        st.write("ë°°ë„ˆ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì–´ìš”. `banner.png` íŒŒì¼ ìœ„ì¹˜ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.")
elif menu == "ê±´ê°• ê¸°ë¡":
    page_health_log()
elif menu == "AI ì§„ë‹¨":
    page_ai_diagnosis()
elif menu == "ì§‘ì‚¬ ê°€ì´ë“œ":
    page_guide()
elif menu == "ì‘ê¸‰ìƒí™© AI":
    page_ai_emergency()
elif menu == "ìŒì‹ ì‚¬ì „":
    page_food_dict()
elif menu == "ë§ˆì¼“":
    page_market()
